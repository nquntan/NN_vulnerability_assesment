from model.vgg import *
import random
from art.utils import projection
from art.utils import random_sphere

import torch.nn as nn
import torch.nn.functional as F
import torch.optim as optim
import numpy as np
from art.utils import load_dataset
from art.classifiers import PyTorchClassifier

import os
os.environ["CUDA_VISIBLE_DEVICES"]="1,2"

         
def test():
    (x_train, y_train), (x_test, y_test), min_, max_ = load_dataset(str('cifar10'))

    x_train = np.swapaxes(x_train, 1, 3).astype(np.float32)
    x_test = np.swapaxes(x_test, 1, 3).astype(np.float32)

    model = VGG('VGG16')
    model.load_state_dict(torch.load("./logs/pytorch_vgg16.h5.model"))
    criterion = nn.CrossEntropyLoss()
    optimizer = optim.Adam(model.parameters(), lr=1e-2)

    classifier = PyTorchClassifier(model=model, clip_values=(min_, max_ ), loss=criterion,
                                optimizer=optimizer, input_shape=(3, 32, 32), nb_classes=10)


    predictions = classifier.predict(x_test)
    accuracy = np.sum(np.argmax(predictions, axis=1) == np.argmax(y_test, axis=1)) / len(y_test)
    print('Accuracy on benign test examples: {}%'.format(accuracy * 100))

if __name__ == "__main__":
    test()